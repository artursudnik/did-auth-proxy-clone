## Prerequisites
- nodejs
- yarn
- docker
- docker compose
- jq (https://stedolan.github.io/jq/download/)

## Installation
```shell
yarn install
```

## Start
```shell
docker-compose up --build
```

## Test
Put your private key into the `PRIVATE_KEY` env variable.

Generate your identity token and store it in the `IDENTITY_TOKEN` env variable.

```shell
export IDENTITY_TOKEN=$(node generate-identity-cli/index.js -p $PRIVATE_KEY -b 999999999999)
```

Now, you can request access and refresh tokens pair:

```shell
curl "http://localhost:8080/auth/login" \
  -Ssf \
  -X POST --header 'Content-Type: application/json' \
  -d "{\"identityToken\": \"$IDENTITY_TOKEN\"}" \
  | jq
```

You will see the following output:
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6ImUxZGI1Y2EyLTNlNTUtNDc5NC04N2U4LWNmMDM2YTNjYjBjMCIsImRpZCI6ImRpZDpldGhyOjB4ODJGY0IzMTM4NUVhQmUyNjFFNGU2MDAzYjlGMkNiMmFmMzRlMjY1NCIsInJvbGVzIjpbInJvbGUxLnJvbGVzLmFwcC10ZXN0Mi5hcHBzLmFydHVyLmlhbS5ld2MiXSwiaWF0IjoxNjQ0OTIzMjk5LCJleHAiOjE2NDQ5MjMzMDl9.XFR4V76W_6Ox8-ocVNDSGBNTLpdBNdo5kU1gvpnovOs",
  "type": "Bearer",
  "expires_in": 9,
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjFkMTQ0M2JkLWFkOTktNGZhZC04ZTYyLTVmOGVlMzI2MWQ5YiIsImRpZCI6ImRpZDpldGhyOjB4ODJGY0IzMTM4NUVhQmUyNjFFNGU2MDAzYjlGMkNiMmFmMzRlMjY1NCIsInJvbGVzIjpbInJvbGUxLnJvbGVzLmFwcC10ZXN0Mi5hcHBzLmFydHVyLmlhbS5ld2MiXSwiaWF0IjoxNjQ0OTIzMjk5LCJleHAiOjE2NDQ5MjM4OTl9.1n8TiG1cPSZEfJdj209TQylWqKyU2BDXHUX4loGyggU"
}
```

You can store access_token in the `ACCESS_TOKEN` env variable:

```shell
export ACCESS_TOKEN=$(curl "http://localhost:8080/auth/login" \
  -Ssf \
  -X POST --header 'Content-Type: application/json' \
  -d "{\"identityToken\": \"$IDENTITY_TOKEN\"}" \
  | jq -r .access_token) 
```

Request an endpoint with the valid access token:
```shell
curl http://127.0.0.1:8080/ -H "Authorization: Bearer $ACCESS_TOKEN"
```

You will see the following response created by the backend service:

```json
{"message":"backend response","timestamp":"2022-02-15T11:15:24.904Z"}
```

Request an endpoint with invalid token:
```shell
curl -v http://127.0.0.1:8080/ -H "Authorization: Bearer invalid-token"
```

You will see the following response generated by the NginX and `401` http response status code:
```html
<html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.21.6</center>
</body>
</html>
```

After your access token expires, you need to regenerate it by providing your refresh token in the following request:
```shell
curl -X POST 'http://localhost:8080/auth/refresh-token' \
   -H 'Content-Type: application/json' \
   --data-raw '{
    "refreshToken": "{{your refresh token here}}"
   }'
```

You will get the same response as in case of `/auth/login` endpoint if your refresh token has not expired yet.
